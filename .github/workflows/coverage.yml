# This is a basic workflow to help you get started with Actions

name: Coverage

# Controls when the action will run. 
on:
  # Triggers the workflow on push or pull request events but only for the main branch
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  # This workflow contains a single job called "build"
  build:
    # The type of runner that the job will run on
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: [3.8]

    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - uses: actions/checkout@v2
      
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v2
        with:
          python-version: ${{ matrix.python-version }}
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install numpy coverage
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          
      - name: Run coverage and Report
        env:
          ACTIONS_ALLOW_UNSECURE_COMMANDS: 'true'
        run: |
          coverage run -m unittest discover -s tests
          PERCENT=$( coverage report -m | tail -1 | awk '{print $4}' )
          COV=$( coverage report -m | tail -1 | awk '{print $4}' | sed 's/%//g' )
          echo $COV
          echo "::set-env name=Percent::$PERCENT"
          if [[ "$COV" -le 50 ]] ; then
            COLOR=red
          elif [[ "$COV" -gt 80 ]] ; then
            COLOR=green
          else
            COLOR=orange
          fi
          echo $COLOR
          echo "::set-env name=CoLoR::$COLOR"
          
      - name: Create Awesome Badge
        uses: schneegans/dynamic-badges-action@v1.0.0
        with:
          auth: ${{ secrets.GIST_SECRET }}
          gistID: c8f263678e4e1f57994fa049a83a85ab
          filename: test.json
          label: Coverage
          logoSvg: data:image/svg;base64,PHN2ZyAgIHhtbG5zOmRjPSJodHRwOi8vcHVybC5vcmcvZGMvZWxlbWVudHMvMS4xLyIgICB4bWxuczpjYz0iaHR0cDovL2NyZWF0aXZlY29tbW9ucy5vcmcvbnMjIiAgIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyIgICB4bWxuczpzdmc9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiAgIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgICB4bWxuczpzb2RpcG9kaT0iaHR0cDovL3NvZGlwb2RpLnNvdXJjZWZvcmdlLm5ldC9EVEQvc29kaXBvZGktMC5kdGQiICAgeG1sbnM6aW5rc2NhcGU9Imh0dHA6Ly93d3cuaW5rc2NhcGUub3JnL25hbWVzcGFjZXMvaW5rc2NhcGUiICAgd2lkdGg9IjIxMG1tIiAgIGhlaWdodD0iMjk3bW0iICAgdmlld0JveD0iMCAwIDIxMCAyOTciICAgdmVyc2lvbj0iMS4xIiAgIGlkPSJzdmc4IiAgIHNvZGlwb2RpOmRvY25hbWU9InNoaWVsZC5zdmciICAgaW5rc2NhcGU6dmVyc2lvbj0iMC45Mi4zICgyNDA1NTQ2LCAyMDE4LTAzLTExKSI+ICA8ZGVmcyAgICAgaWQ9ImRlZnMyIj4gICAgPG1hc2sgICAgICAgbWFza1VuaXRzPSJ1c2VyU3BhY2VPblVzZSIgICAgICAgaWQ9Im1hc2s4MzgiPiAgICAgIDxyZWN0ICAgICAgICAgc3R5bGU9Im9wYWNpdHk6MC40NDYwMDAwNDtmaWxsOiNmZmZmZmY7ZmlsbC1vcGFjaXR5OjE7c3Ryb2tlOm5vbmU7c3Ryb2tlLXdpZHRoOjAuMjY0OTk5OTk7c3Ryb2tlLW1pdGVybGltaXQ6NDtzdHJva2UtZGFzaGFycmF5Om5vbmU7c3Ryb2tlLWRhc2hvZmZzZXQ6MDtzdHJva2Utb3BhY2l0eToxIiAgICAgICAgIGlkPSJyZWN0ODQwIiAgICAgICAgIHdpZHRoPSIxNDAuMjUzMDgiICAgICAgICAgaGVpZ2h0PSIxNDEuODQzMjUiICAgICAgICAgeD0iLTMxLjQ4NTM4OCIgICAgICAgICB5PSI3Ni45MjAzMzQiIC8+ICAgIDwvbWFzaz4gIDwvZGVmcz4gIDxzb2RpcG9kaTpuYW1lZHZpZXcgICAgIGlkPSJiYXNlIiAgICAgcGFnZWNvbG9yPSIjZmZmZmZmIiAgICAgYm9yZGVyY29sb3I9IiM2NjY2NjYiICAgICBib3JkZXJvcGFjaXR5PSIxLjAiICAgICBpbmtzY2FwZTpwYWdlb3BhY2l0eT0iMC4wIiAgICAgaW5rc2NhcGU6cGFnZXNoYWRvdz0iMiIgICAgIGlua3NjYXBlOnpvb209IjEuNjYzODY3MiIgICAgIGlua3NjYXBlOmN4PSIyMTYuNzAzNzMiICAgICBpbmtzY2FwZTpjeT0iODcxLjIxNDA3IiAgICAgaW5rc2NhcGU6ZG9jdW1lbnQtdW5pdHM9Im1tIiAgICAgaW5rc2NhcGU6Y3VycmVudC1sYXllcj0iZzg1MyIgICAgIHNob3dncmlkPSJmYWxzZSIgICAgIGlua3NjYXBlOndpbmRvdy13aWR0aD0iMTcxOCIgICAgIGlua3NjYXBlOndpbmRvdy1oZWlnaHQ9IjEzNzgiICAgICBpbmtzY2FwZTp3aW5kb3cteD0iMjU1MyIgICAgIGlua3NjYXBlOndpbmRvdy15PSIwIiAgICAgaW5rc2NhcGU6d2luZG93LW1heGltaXplZD0iMCIgLz4gIDxtZXRhZGF0YSAgICAgaWQ9Im1ldGFkYXRhNSI+ICAgIDxyZGY6UkRGPiAgICAgIDxjYzpXb3JrICAgICAgICAgcmRmOmFib3V0PSIiPiAgICAgICAgPGRjOmZvcm1hdD5pbWFnZS9zdmcreG1sPC9kYzpmb3JtYXQ+ICAgICAgICA8ZGM6dHlwZSAgICAgICAgICAgcmRmOnJlc291cmNlPSJodHRwOi8vcHVybC5vcmcvZGMvZGNtaXR5cGUvU3RpbGxJbWFnZSIgLz4gICAgICA8L2NjOldvcms+ICAgIDwvcmRmOlJERj4gIDwvbWV0YWRhdGE+ICA8ZyAgICAgaW5rc2NhcGU6bGFiZWw9IkxheWVyIDEiICAgICBpbmtzY2FwZTpncm91cG1vZGU9ImxheWVyIiAgICAgaWQ9ImxheWVyMSI+ICAgIDxnICAgICAgIGlkPSJnODUzIiAgICAgICB0cmFuc2Zvcm09InRyYW5zbGF0ZSgtNTIuNzkzNjc3LC02MC4xMDg0NjMpIj4gICAgICA8cGF0aCAgICAgICAgIGlkPSJwYXRoODQyIiAgICAgICAgIGQ9Ik0gNjguMzY0NTgxLDkwLjI5NjMzNyAxMDYuMzcsNzYuNzY4MTUxIFYgMTcwLjEwOTEyIEMgNzIuOTc0NzA1LDE0OC41MjAyNCA3NC4yMTE1NjgsMTQxLjc5NDgxIDY4LjM2NDU4MSw5MC4yOTYzMzcgWiIgICAgICAgICBzdHlsZT0iZmlsbDojZTc3ODAwO2ZpbGwtb3BhY2l0eToxO3N0cm9rZTojZTc3ODAwO3N0cm9rZS13aWR0aDowLjI2NDU4MzMycHg7c3Ryb2tlLWxpbmVjYXA6YnV0dDtzdHJva2UtbGluZWpvaW46bWl0ZXI7c3Ryb2tlLW9wYWNpdHk6MSIgICAgICAgICBpbmtzY2FwZTpjb25uZWN0b3ItY3VydmF0dXJlPSIwIiAvPiAgICAgIDxwYXRoICAgICAgICAgaWQ9InBhdGg4NDgiICAgICAgICAgc3R5bGU9ImZpbGw6IzAwMDAwMDtmaWxsLW9wYWNpdHk6MTtzdHJva2U6IzAwMDAwMDtzdHJva2Utd2lkdGg6MC4yNjQ1ODMzMnB4O3N0cm9rZS1saW5lY2FwOmJ1dHQ7c3Ryb2tlLWxpbmVqb2luOm1pdGVyO3N0cm9rZS1vcGFjaXR5OjEiICAgICAgICAgZD0ibSAxNDkuNTg3NDYsODYuOTAxOTg5IGMgLTYuODU4OTcsNjAuNjA2MjcxIC00LjgzNTAyLDYwLjEyODQwMSAtNDIuOTUyODgsODguODAxMTMxIHYgNS41OTM5OSBjIDQ2LjEwMTI1LC0zMS4zNzEzNCAzOS44ODc2MiwtMzQuNjI2MDUgNDcuNTMzNjgsLTk4LjQ5MzE0MyBsIC00Ny41MzM2OCwtMTYuMzEwMjEgdiA1LjEzNzE5NyB6IG0gLTg2LjE3MDMzLDAgYyA2Ljg1ODk2Niw2MC42MDYyNzEgNC44MzUwMDksNjAuMTI4NDAxIDQyLjk1Mjg3LDg4LjgwMTEzMSB2IDUuNTkzOTkgQyA2MC4yNjg3NTIsMTQ5LjkyNTc3IDY2LjQ4MjM4NywxNDYuNjcxMDYgNTguODM2MzI2LDgyLjgwMzk2NyBMIDEwNi4zNyw2Ni40OTM3NTcgdiA1LjEzNzE5NyB6IiAgICAgICAgIGlua3NjYXBlOmNvbm5lY3Rvci1jdXJ2YXR1cmU9IjAiIC8+ICAgIDwvZz4gIDwvZz48L3N2Zz4=
          message: ${{ env.Percent }}
          color: ${{ env.CoLoR }}
